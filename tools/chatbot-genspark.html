<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic PDF Form Builder - GenSpark AI Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .drag-over { border: 2px dashed #3b82f6 !important; background: #eff6ff !important; }
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .field-item { transition: all 0.2s ease; }
        .field-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .flowable-grid { display: flex; flex-wrap: wrap; gap: 1rem; }
        .flowable-grid .form-field { flex: 1 1 calc(50% - 0.5rem); min-width: 280px; }
        .flowable-grid .form-field.full-width { flex: 1 1 100%; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: slideIn 0.3s ease forwards; }
        .pdf-preview { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        /* View Mode Styles */
        .view-screen #formBuilder { max-width: 100%; width: 100%; }
        .view-paper #formBuilder { 
            width: 210mm; 
            min-height: 297mm; 
            max-width: 210mm;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .view-paper-area {
            background: #6b7280 !important;
            padding: 2rem !important;
        }
        .view-paper-area #formBuilder { 
            width: 210mm; 
            min-height: 297mm; 
            max-width: 210mm;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .view-paper-fit #formBuilder {
            width: 100%;
            max-width: 210mm;
            min-height: calc(100vw * 1.414);
            max-height: 297mm;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform-origin: top center;
        }
        @media (max-width: 210mm) {
            .view-paper #formBuilder,
            .view-paper-area #formBuilder {
                width: 100%;
                min-height: auto;
            }
        }

        /* Chatbot Animations */
        @keyframes chatSlideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes chatSlideOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(20px) scale(0.95); }
        }
        #chatWindow {
            transform-origin: bottom left;
        }
        .chat-bubble-animation {
            animation: bubbleIn 0.3s ease forwards;
        }
        @keyframes bubbleIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Chatbot responsive */
        @media (max-width: 450px) {
            #chatWindow {
                width: calc(100vw - 3rem);
                left: 0;
                right: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 pdf-preview rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Dynamic PDF Form Builder</h1>
                    <div class="flex items-center gap-2">
                        <p class="text-sm text-gray-500">Flowable Layout System</p>
                        <span class="px-2 py-0.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-xs font-semibold rounded-full">‚ú® GenSpark AI Powered</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="createNewForm()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Create New
                </button>
                <button onclick="togglePreview()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Preview
                </button>
                <button onclick="exportToPDF()" class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-lg font-medium transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export PDF
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6 flex gap-6">
        <!-- Sidebar - Field Types -->
        <aside class="w-72 flex-shrink-0">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sticky top-6">
                <h2 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add Fields
                </h2>
                <div class="space-y-2" id="fieldTypes">
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="text">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üìù</span>
                            <span class="font-medium text-gray-700">Text Input</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="email">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">‚úâÔ∏è</span>
                            <span class="font-medium text-gray-700">Email</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="phone">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üì±</span>
                            <span class="font-medium text-gray-700">Phone</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="textarea">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üìÑ</span>
                            <span class="font-medium text-gray-700">Text Area</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="number">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üî¢</span>
                            <span class="font-medium text-gray-700">Number</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="date">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üìÖ</span>
                            <span class="font-medium text-gray-700">Date</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="select">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üìã</span>
                            <span class="font-medium text-gray-700">Dropdown</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="checkbox">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">‚òëÔ∏è</span>
                            <span class="font-medium text-gray-700">Checkbox</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="radio">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üîò</span>
                            <span class="font-medium text-gray-700">Radio Group</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="file">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üìé</span>
                            <span class="font-medium text-gray-700">File Upload</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="heading">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üè∑Ô∏è</span>
                            <span class="font-medium text-gray-700">Section Heading</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="paragraph">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">¬∂</span>
                            <span class="font-medium text-gray-700">Paragraph</span>
                        </div>
                    </div>
                    <div class="field-item p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-indigo-50 border border-transparent hover:border-indigo-200" draggable="true" data-type="divider">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">‚ûñ</span>
                            <span class="font-medium text-gray-700">Divider</span>
                        </div>
                    </div>
                </div>

                <!-- Layout Options -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="font-semibold text-gray-800 mb-3">Layout Options</h3>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="layout" value="flowable" checked onchange="updateLayout(this.value)" class="text-indigo-500">
                            <span class="text-sm text-gray-700">Flowable (2 columns)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="layout" value="single" onchange="updateLayout(this.value)" class="text-indigo-500">
                            <span class="text-sm text-gray-700">Single Column</span>
                        </label>
                    </div>
                </div>

                <!-- View Mode Options -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        View Mode
                    </h3>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition">
                            <input type="radio" name="viewMode" value="screen" checked onchange="updateViewMode(this.value)" class="text-indigo-500">
                            <div>
                                <span class="text-sm font-medium text-gray-700 block">Fit to Screen</span>
                                <span class="text-xs text-gray-500">Full width canvas</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition">
                            <input type="radio" name="viewMode" value="paper" onchange="updateViewMode(this.value)" class="text-indigo-500">
                            <div>
                                <span class="text-sm font-medium text-gray-700 block">Fit to Paper</span>
                                <span class="text-xs text-gray-500">A4 paper width</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition">
                            <input type="radio" name="viewMode" value="paper-area" onchange="updateViewMode(this.value)" class="text-indigo-500">
                            <div>
                                <span class="text-sm font-medium text-gray-700 block">Fit to Paper Area</span>
                                <span class="text-xs text-gray-500">A4 with dark background</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Form Settings -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="font-semibold text-gray-800 mb-3">Form Title</h3>
                    <input type="text" id="formTitle" value="My Dynamic Form" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="updateFormTitle()">
                </div>
            </div>
        </aside>

        <!-- Main Form Builder Area -->
        <main id="mainArea" class="flex-1 transition-all duration-300">
            <div id="formBuilder" class="bg-white rounded-xl shadow-sm border border-gray-200 min-h-[600px] transition-all duration-300">
                <!-- Form Header -->
                <div class="p-6 border-b border-gray-200">
                    <h2 id="formTitleDisplay" class="text-2xl font-bold text-gray-800">My Dynamic Form</h2>
                    <p class="text-gray-500 mt-1">Drag and drop fields to build your form</p>
                </div>

                <!-- Drop Zone -->
                <div id="dropZone" class="p-6 flowable-grid min-h-[400px]">
                    <div id="emptyState" class="w-full flex flex-col items-center justify-center py-16 text-gray-400">
                        <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-lg font-medium">Drop fields here</p>
                        <p class="text-sm">or click on a field type to add it</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Field Properties Panel -->
        <aside id="propertiesPanel" class="w-80 flex-shrink-0 hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sticky top-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold text-gray-800">Field Properties</h2>
                    <button onclick="closePropertiesPanel()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div id="propertiesContent" class="space-y-4">
                    <!-- Dynamic properties will be inserted here -->
                </div>
            </div>
        </aside>
    </div>

    <!-- AI Chatbot -->
    <div id="chatbot" class="fixed bottom-6 left-6 z-50">
        <!-- Chat Toggle Button -->
        <button id="chatToggle" onclick="toggleChat()" class="w-14 h-14 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110">
            <svg id="chatIconOpen" class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <svg id="chatIconClose" class="w-7 h-7 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>

        <!-- Chat Window -->
        <div id="chatWindow" class="hidden absolute bottom-20 left-0 w-96 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden transform transition-all duration-300">
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold">AI Form Assistant</h3>
                            <p class="text-xs text-white/80">Powered by GenSpark AI (gpt-5-mini)</p>
                        </div>
                    </div>
                    <button onclick="toggleApiSettings()" class="p-2 hover:bg-white/20 rounded-lg transition" title="API Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>

                <!-- API Settings Panel -->
                <div id="apiSettings" class="hidden mt-4 p-3 bg-white/10 rounded-lg">
                    <label class="block text-xs text-white/80 mb-1">GenSpark API Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="apiKeyInput" placeholder="sk-..." class="flex-1 px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/50 text-sm border border-white/30 focus:outline-none focus:border-white/60">
                        <button onclick="saveApiKey()" class="px-3 py-2 bg-white text-emerald-600 rounded-lg text-sm font-medium hover:bg-white/90 transition">Save</button>
                    </div>
                    <p class="text-xs text-white/60 mt-2">Your API key is stored locally in your browser.</p>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="h-80 overflow-y-auto p-4 space-y-4 bg-gray-50">
                <!-- Welcome Message -->
                <div class="flex gap-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none px-4 py-3 shadow-sm max-w-[80%]">
                        <p class="text-sm text-gray-700">üëã Hello! I'm your AI Form Assistant. I can help you:</p>
                        <ul class="text-sm text-gray-600 mt-2 space-y-1">
                            <li>‚Ä¢ Create form fields</li>
                            <li>‚Ä¢ Get form building tips</li>
                            <li>‚Ä¢ Answer questions about PDF forms</li>
                        </ul>
                        <p class="text-xs text-gray-400 mt-2">Set up your GenSpark API key using the ‚öôÔ∏è button above.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 bg-white border-t border-gray-200">
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Ask me anything about forms..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()" class="px-4 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white rounded-xl transition flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>
                <p id="chatStatus" class="text-xs text-gray-400 mt-2 text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white">
                <h2 class="text-xl font-bold text-gray-800">Form Preview</h2>
                <button onclick="togglePreview()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="previewContent" class="p-6">
                <!-- Preview content will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        // Form state
        let formFields = [];
        let selectedFieldId = null;
        let fieldIdCounter = 0;
        let currentLayout = 'flowable';
        let currentViewMode = 'screen';

        // Field type configurations
        const fieldConfigs = {
            text: { label: 'Text Field', placeholder: 'Enter text...', icon: 'üìù' },
            email: { label: 'Email Address', placeholder: 'email@example.com', icon: '‚úâÔ∏è' },
            phone: { label: 'Phone Number', placeholder: '+1 (555) 000-0000', icon: 'üì±' },
            textarea: { label: 'Text Area', placeholder: 'Enter detailed text...', icon: 'üìÑ', fullWidth: true },
            number: { label: 'Number', placeholder: '0', icon: 'üî¢' },
            date: { label: 'Date', placeholder: '', icon: 'üìÖ' },
            select: { label: 'Dropdown', options: ['Option 1', 'Option 2', 'Option 3'], icon: 'üìã' },
            checkbox: { label: 'Checkbox', options: ['Option 1', 'Option 2'], icon: '‚òëÔ∏è' },
            radio: { label: 'Radio Group', options: ['Option 1', 'Option 2', 'Option 3'], icon: 'üîò' },
            file: { label: 'File Upload', accept: '*', icon: 'üìé' },
            heading: { label: 'Section Title', icon: 'üè∑Ô∏è', fullWidth: true },
            paragraph: { label: 'Paragraph Text', content: 'Enter your paragraph text here. You can use this field to add instructions, descriptions, or any informational text to your form.', icon: '¬∂', fullWidth: true, fontSize: 'normal', textAlign: 'left', textStyle: 'normal' },
            divider: { label: 'Divider', icon: '‚ûñ', fullWidth: true }
        };

        // Initialize drag and drop for field types
        document.querySelectorAll('#fieldTypes .field-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('click', () => addField(item.dataset.type));
        });

        // Drop zone setup
        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);

        function handleDragStart(e) {
            e.dataTransfer.setData('fieldType', e.target.closest('[data-type]').dataset.type);
            e.dataTransfer.setData('isNew', 'true');
        }

        function handleDragOver(e) {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            dropZone.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const fieldType = e.dataTransfer.getData('fieldType');
            const isNew = e.dataTransfer.getData('isNew') === 'true';
            
            if (isNew && fieldType) {
                addField(fieldType);
            }
        }

        function addField(type) {
            const config = fieldConfigs[type];
            const field = {
                id: ++fieldIdCounter,
                type: type,
                label: config.label,
                placeholder: config.placeholder || '',
                required: false,
                fullWidth: config.fullWidth || false,
                options: config.options ? [...config.options] : [],
                // Paragraph-specific properties
                content: config.content || '',
                fontSize: config.fontSize || 'normal',
                textAlign: config.textAlign || 'left',
                textStyle: config.textStyle || 'normal'
            };

            formFields.push(field);
            renderFormFields();
            selectField(field.id);
        }

        function renderFormFields() {
            const emptyState = document.getElementById('emptyState');
            
            // Remove existing field elements (but keep empty state)
            dropZone.querySelectorAll('.form-field').forEach(el => el.remove());

            if (formFields.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            formFields.forEach(field => {
                const fieldEl = createFieldElement(field);
                dropZone.appendChild(fieldEl);
            });
        }

        function createFieldElement(field) {
            const div = document.createElement('div');
            div.className = `form-field bg-gray-50 rounded-lg p-4 border-2 border-transparent hover:border-indigo-200 cursor-pointer animate-in ${field.fullWidth ? 'full-width' : ''} ${selectedFieldId === field.id ? 'border-indigo-500 bg-indigo-50' : ''}`;
            div.dataset.id = field.id;
            div.draggable = true;

            let inputHtml = '';
            const config = fieldConfigs[field.type];

            switch (field.type) {
                case 'text':
                case 'email':
                case 'phone':
                case 'number':
                    inputHtml = `<input type="${field.type === 'phone' ? 'tel' : field.type}" placeholder="${field.placeholder}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white" disabled>`;
                    break;
                case 'textarea':
                    inputHtml = `<textarea placeholder="${field.placeholder}" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white resize-none" rows="3" disabled></textarea>`;
                    break;
                case 'date':
                    inputHtml = `<input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white" disabled>`;
                    break;
                case 'select':
                    inputHtml = `<select class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white" disabled>
                        <option>Select an option...</option>
                        ${field.options.map(opt => `<option>${opt}</option>`).join('')}
                    </select>`;
                    break;
                case 'checkbox':
                    inputHtml = `<div class="space-y-2">${field.options.map(opt => `
                        <label class="flex items-center gap-2">
                            <input type="checkbox" class="rounded" disabled>
                            <span class="text-gray-700">${opt}</span>
                        </label>
                    `).join('')}</div>`;
                    break;
                case 'radio':
                    inputHtml = `<div class="space-y-2">${field.options.map(opt => `
                        <label class="flex items-center gap-2">
                            <input type="radio" name="radio_${field.id}" disabled>
                            <span class="text-gray-700">${opt}</span>
                        </label>
                    `).join('')}</div>`;
                    break;
                case 'file':
                    inputHtml = `<div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center bg-white">
                        <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-sm text-gray-500">Click to upload or drag and drop</p>
                    </div>`;
                    break;
                case 'heading':
                    inputHtml = `<div class="text-lg font-semibold text-gray-800 border-b-2 border-indigo-500 pb-2">${field.label}</div>`;
                    break;
                case 'paragraph':
                    const pFontSize = field.fontSize === 'small' ? 'text-sm' : field.fontSize === 'large' ? 'text-lg' : 'text-base';
                    const pTextAlign = field.textAlign === 'center' ? 'text-center' : field.textAlign === 'right' ? 'text-right' : field.textAlign === 'justify' ? 'text-justify' : 'text-left';
                    const pTextStyle = field.textStyle === 'bold' ? 'font-bold' : field.textStyle === 'italic' ? 'italic' : field.textStyle === 'bold-italic' ? 'font-bold italic' : '';
                    inputHtml = `<div class="paragraph-content ${pFontSize} ${pTextAlign} ${pTextStyle} text-gray-600 leading-relaxed">${field.content}</div>`;
                    break;
                case 'divider':
                    inputHtml = `<hr class="border-t-2 border-gray-300">`;
                    break;
            }

            div.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${config.icon}</span>
                        ${field.type !== 'heading' && field.type !== 'divider' && field.type !== 'paragraph' ? `
                            <label class="font-medium text-gray-700">
                                ${field.label}
                                ${field.required ? '<span class="text-red-500">*</span>' : ''}
                            </label>
                        ` : ''}
                        ${field.type === 'paragraph' ? `<span class="text-sm text-gray-500">Paragraph</span>` : ''}
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="event.stopPropagation(); moveField(${field.id}, -1)" class="p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
                        </button>
                        <button onclick="event.stopPropagation(); moveField(${field.id}, 1)" class="p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <button onclick="event.stopPropagation(); deleteField(${field.id})" class="p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                </div>
                ${field.type !== 'heading' ? inputHtml : inputHtml}
            `;

            div.addEventListener('click', () => selectField(field.id));

            return div;
        }

        function selectField(id) {
            selectedFieldId = id;
            renderFormFields();
            showPropertiesPanel(id);
        }

        function showPropertiesPanel(id) {
            const field = formFields.find(f => f.id === id);
            if (!field) return;

            const panel = document.getElementById('propertiesPanel');
            const content = document.getElementById('propertiesContent');
            
            let optionsHtml = '';
            if (['select', 'checkbox', 'radio'].includes(field.type)) {
                optionsHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Options</label>
                        <div id="optionsList" class="space-y-2">
                            ${field.options.map((opt, i) => `
                                <div class="flex gap-2">
                                    <input type="text" value="${opt}" onchange="updateOption(${id}, ${i}, this.value)" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <button onclick="removeOption(${id}, ${i})" class="px-2 text-red-500 hover:bg-red-50 rounded">√ó</button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addOption(${id})" class="mt-2 text-sm text-indigo-600 hover:text-indigo-700 font-medium">+ Add Option</button>
                    </div>
                `;
            }

            // Paragraph-specific properties HTML
            let paragraphHtml = '';
            if (field.type === 'paragraph') {
                paragraphHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                        <textarea onchange="updateField(${id}, 'content', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500" rows="4">${field.content}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Font Size</label>
                        <select onchange="updateField(${id}, 'fontSize', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                            <option value="small" ${field.fontSize === 'small' ? 'selected' : ''}>Small</option>
                            <option value="normal" ${field.fontSize === 'normal' ? 'selected' : ''}>Normal</option>
                            <option value="large" ${field.fontSize === 'large' ? 'selected' : ''}>Large</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Text Alignment</label>
                        <div class="flex gap-1">
                            <button onclick="updateField(${id}, 'textAlign', 'left')" class="flex-1 px-3 py-2 border rounded-lg text-sm ${field.textAlign === 'left' ? 'bg-indigo-500 text-white border-indigo-500' : 'border-gray-300 hover:bg-gray-50'}">
                                <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h10M4 18h14"/></svg>
                            </button>
                            <button onclick="updateField(${id}, 'textAlign', 'center')" class="flex-1 px-3 py-2 border rounded-lg text-sm ${field.textAlign === 'center' ? 'bg-indigo-500 text-white border-indigo-500' : 'border-gray-300 hover:bg-gray-50'}">
                                <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M7 12h10M5 18h14"/></svg>
                            </button>
                            <button onclick="updateField(${id}, 'textAlign', 'right')" class="flex-1 px-3 py-2 border rounded-lg text-sm ${field.textAlign === 'right' ? 'bg-indigo-500 text-white border-indigo-500' : 'border-gray-300 hover:bg-gray-50'}">
                                <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M10 12h10M6 18h14"/></svg>
                            </button>
                            <button onclick="updateField(${id}, 'textAlign', 'justify')" class="flex-1 px-3 py-2 border rounded-lg text-sm ${field.textAlign === 'justify' ? 'bg-indigo-500 text-white border-indigo-500' : 'border-gray-300 hover:bg-gray-50'}">
                                <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Text Style</label>
                        <div class="flex gap-1">
                            <button onclick="updateField(${id}, 'textStyle', 'normal')" class="flex-1 px-3 py-2 border rounded-lg text-sm ${field.textStyle === 'normal' ? 'bg-indigo-500 text-white border-indigo-500' : 'border-gray-300 hover:bg-gray-50'}">Normal</button>
                            <button onclick="updateField(${id}, 'textStyle', 'bold')" class="flex-1 px-3 py-2 border rounded-lg text-sm font-bold ${field.textStyle === 'bold' ? 'bg-indigo-500 text-white border-indigo-500' : 'border-gray-300 hover:bg-gray-50'}">Bold</button>
                            <button onclick="updateField(${id}, 'textStyle', 'italic')" class="flex-1 px-3 py-2 border rounded-lg text-sm italic ${field.textStyle === 'italic' ? 'bg-indigo-500 text-white border-indigo-500' : 'border-gray-300 hover:bg-gray-50'}">Italic</button>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
                ${field.type !== 'paragraph' ? `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                    <input type="text" value="${field.label}" onchange="updateField(${id}, 'label', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                </div>
                ` : ''}
                ${field.placeholder !== undefined && field.type !== 'heading' && field.type !== 'divider' && field.type !== 'paragraph' ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Placeholder</label>
                        <input type="text" value="${field.placeholder}" onchange="updateField(${id}, 'placeholder', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                    </div>
                ` : ''}
                ${field.type !== 'heading' && field.type !== 'divider' && field.type !== 'paragraph' ? `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="required_${id}" ${field.required ? 'checked' : ''} onchange="updateField(${id}, 'required', this.checked)" class="rounded text-indigo-500">
                        <label for="required_${id}" class="text-sm text-gray-700">Required field</label>
                    </div>
                ` : ''}
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="fullWidth_${id}" ${field.fullWidth ? 'checked' : ''} onchange="updateField(${id}, 'fullWidth', this.checked)" class="rounded text-indigo-500">
                    <label for="fullWidth_${id}" class="text-sm text-gray-700">Full width</label>
                </div>
                ${paragraphHtml}
                ${optionsHtml}
            `;

            panel.classList.remove('hidden');
        }

        function closePropertiesPanel() {
            document.getElementById('propertiesPanel').classList.add('hidden');
            selectedFieldId = null;
            renderFormFields();
        }

        function updateField(id, property, value) {
            const field = formFields.find(f => f.id === id);
            if (field) {
                field[property] = value;
                renderFormFields();
                showPropertiesPanel(id);
            }
        }

        function updateOption(id, index, value) {
            const field = formFields.find(f => f.id === id);
            if (field && field.options) {
                field.options[index] = value;
                renderFormFields();
            }
        }

        function addOption(id) {
            const field = formFields.find(f => f.id === id);
            if (field && field.options) {
                field.options.push(`Option ${field.options.length + 1}`);
                renderFormFields();
                showPropertiesPanel(id);
            }
        }

        function removeOption(id, index) {
            const field = formFields.find(f => f.id === id);
            if (field && field.options && field.options.length > 1) {
                field.options.splice(index, 1);
                renderFormFields();
                showPropertiesPanel(id);
            }
        }

        function moveField(id, direction) {
            const index = formFields.findIndex(f => f.id === id);
            const newIndex = index + direction;
            
            if (newIndex >= 0 && newIndex < formFields.length) {
                const temp = formFields[index];
                formFields[index] = formFields[newIndex];
                formFields[newIndex] = temp;
                renderFormFields();
            }
        }

        function deleteField(id) {
            formFields = formFields.filter(f => f.id !== id);
            if (selectedFieldId === id) {
                closePropertiesPanel();
            }
            renderFormFields();
        }

        function updateLayout(layout) {
            currentLayout = layout;
            const dropZone = document.getElementById('dropZone');
            
            if (layout === 'single') {
                dropZone.classList.remove('flowable-grid');
                dropZone.classList.add('space-y-4');
            } else {
                dropZone.classList.add('flowable-grid');
                dropZone.classList.remove('space-y-4');
            }
        }

        function updateViewMode(mode) {
            currentViewMode = mode;
            const mainArea = document.getElementById('mainArea');
            
            // Remove all view mode classes
            mainArea.classList.remove('view-screen', 'view-paper', 'view-paper-area', 'view-paper-fit');
            
            // Add the selected view mode class
            switch (mode) {
                case 'screen':
                    mainArea.classList.add('view-screen');
                    break;
                case 'paper':
                    mainArea.classList.add('view-paper');
                    break;
                case 'paper-area':
                    mainArea.classList.add('view-paper-area');
                    break;
            }
        }

        function updateFormTitle() {
            const title = document.getElementById('formTitle').value;
            document.getElementById('formTitleDisplay').textContent = title;
        }

        function togglePreview() {
            const modal = document.getElementById('previewModal');
            const content = document.getElementById('previewContent');
            
            if (modal.classList.contains('hidden')) {
                content.innerHTML = generatePreviewHtml();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function generatePreviewHtml() {
            if (formFields.length === 0) {
                return '<p class="text-center text-gray-500">No fields added yet.</p>';
            }

            const formTitle = document.getElementById('formTitle').value;
            let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6">${formTitle}</h2>`;
            html += `<form class="${currentLayout === 'flowable' ? 'flowable-grid' : 'space-y-4'}">`;

            formFields.forEach(field => {
                const widthClass = field.fullWidth || currentLayout === 'single' ? 'full-width' : '';
                html += `<div class="form-field ${widthClass}">`;

                if (field.type !== 'heading' && field.type !== 'divider' && field.type !== 'paragraph') {
                    html += `<label class="block text-sm font-medium text-gray-700 mb-1">${field.label}${field.required ? '<span class="text-red-500">*</span>' : ''}</label>`;
                }

                switch (field.type) {
                    case 'text':
                    case 'email':
                    case 'phone':
                    case 'number':
                        html += `<input type="${field.type === 'phone' ? 'tel' : field.type}" placeholder="${field.placeholder}" ${field.required ? 'required' : ''} class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">`;
                        break;
                    case 'textarea':
                        html += `<textarea placeholder="${field.placeholder}" ${field.required ? 'required' : ''} class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>`;
                        break;
                    case 'date':
                        html += `<input type="date" ${field.required ? 'required' : ''} class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">`;
                        break;
                    case 'select':
                        html += `<select ${field.required ? 'required' : ''} class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select an option...</option>
                            ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>`;
                        break;
                    case 'checkbox':
                        html += `<div class="space-y-2">${field.options.map(opt => `
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="rounded text-indigo-500">
                                <span class="text-gray-700">${opt}</span>
                            </label>
                        `).join('')}</div>`;
                        break;
                    case 'radio':
                        html += `<div class="space-y-2">${field.options.map(opt => `
                            <label class="flex items-center gap-2">
                                <input type="radio" name="preview_radio_${field.id}" class="text-indigo-500">
                                <span class="text-gray-700">${opt}</span>
                            </label>
                        `).join('')}</div>`;
                        break;
                    case 'file':
                        html += `<input type="file" class="w-full px-3 py-2 border border-gray-300 rounded-lg">`;
                        break;
                    case 'heading':
                        html += `<h3 class="text-lg font-semibold text-gray-800 border-b-2 border-indigo-500 pb-2">${field.label}</h3>`;
                        break;
                    case 'paragraph':
                        const prevFontSize = field.fontSize === 'small' ? 'text-sm' : field.fontSize === 'large' ? 'text-lg' : 'text-base';
                        const prevTextAlign = field.textAlign === 'center' ? 'text-center' : field.textAlign === 'right' ? 'text-right' : field.textAlign === 'justify' ? 'text-justify' : 'text-left';
                        const prevTextStyle = field.textStyle === 'bold' ? 'font-bold' : field.textStyle === 'italic' ? 'italic' : field.textStyle === 'bold-italic' ? 'font-bold italic' : '';
                        html += `<p class="${prevFontSize} ${prevTextAlign} ${prevTextStyle} text-gray-600 leading-relaxed">${field.content}</p>`;
                        break;
                    case 'divider':
                        html += `<hr class="border-t-2 border-gray-300 my-4">`;
                        break;
                }

                html += '</div>';
            });

            html += `<div class="full-width mt-6"><button type="submit" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg font-medium hover:from-indigo-600 hover:to-purple-700 transition">Submit Form</button></div>`;
            html += '</form>';

            return html;
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const formTitle = document.getElementById('formTitle').value;
            
            let y = 20;
            const margin = 20;
            const pageWidth = doc.internal.pageSize.width;
            const maxWidth = pageWidth - (margin * 2);

            // Title
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(formTitle, margin, y);
            y += 15;

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');

            formFields.forEach(field => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }

                switch (field.type) {
                    case 'heading':
                        y += 5;
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(field.label, margin, y);
                        doc.setDrawColor(99, 102, 241);
                        doc.setLineWidth(0.5);
                        doc.line(margin, y + 2, margin + doc.getTextWidth(field.label), y + 2);
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'normal');
                        y += 10;
                        break;

                    case 'paragraph':
                        // Set font size based on field setting
                        const pdfFontSize = field.fontSize === 'small' ? 9 : field.fontSize === 'large' ? 13 : 11;
                        doc.setFontSize(pdfFontSize);
                        
                        // Set font style
                        if (field.textStyle === 'bold') {
                            doc.setFont('helvetica', 'bold');
                        } else if (field.textStyle === 'italic') {
                            doc.setFont('helvetica', 'italic');
                        } else if (field.textStyle === 'bold-italic') {
                            doc.setFont('helvetica', 'bolditalic');
                        } else {
                            doc.setFont('helvetica', 'normal');
                        }
                        
                        doc.setTextColor(100, 100, 100);
                        
                        // Split text for wrapping
                        const splitText = doc.splitTextToSize(field.content, maxWidth);
                        
                        // Check if we need a new page
                        const textHeight = splitText.length * (pdfFontSize * 0.5);
                        if (y + textHeight > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        // Set alignment
                        let textX = margin;
                        let textAlign = 'left';
                        if (field.textAlign === 'center') {
                            textX = pageWidth / 2;
                            textAlign = 'center';
                        } else if (field.textAlign === 'right') {
                            textX = pageWidth - margin;
                            textAlign = 'right';
                        }
                        
                        splitText.forEach(line => {
                            doc.text(line, textX, y, { align: textAlign });
                            y += pdfFontSize * 0.5;
                        });
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'normal');
                        y += 5;
                        break;

                    case 'divider':
                        y += 3;
                        doc.setDrawColor(200, 200, 200);
                        doc.setLineWidth(0.3);
                        doc.line(margin, y, pageWidth - margin, y);
                        y += 8;
                        break;

                    default:
                        // Label
                        doc.setFont('helvetica', 'bold');
                        doc.text(field.label + (field.required ? ' *' : ''), margin, y);
                        y += 6;

                        // Input field representation
                        doc.setFont('helvetica', 'normal');
                        doc.setDrawColor(200, 200, 200);
                        doc.setFillColor(250, 250, 250);

                        if (field.type === 'textarea') {
                            doc.roundedRect(margin, y - 3, maxWidth, 25, 2, 2, 'FD');
                            doc.setTextColor(150, 150, 150);
                            doc.text(field.placeholder || 'Enter text...', margin + 5, y + 5);
                            doc.setTextColor(0, 0, 0);
                            y += 30;
                        } else if (field.type === 'checkbox' || field.type === 'radio') {
                            field.options.forEach(opt => {
                                doc.rect(margin, y - 3, 4, 4);
                                doc.text(opt, margin + 8, y);
                                y += 8;
                            });
                            y += 2;
                        } else if (field.type === 'select') {
                            doc.roundedRect(margin, y - 3, maxWidth, 10, 2, 2, 'FD');
                            doc.setTextColor(150, 150, 150);
                            doc.text('Select an option...', margin + 5, y + 3);
                            doc.setTextColor(0, 0, 0);
                            y += 15;
                        } else if (field.type === 'file') {
                            doc.setDrawColor(200, 200, 200);
                            doc.setLineDash([2, 2], 0);
                            doc.roundedRect(margin, y - 3, maxWidth, 20, 2, 2, 'D');
                            doc.setLineDash([]);
                            doc.setTextColor(150, 150, 150);
                            doc.text('Click to upload file', pageWidth / 2, y + 7, { align: 'center' });
                            doc.setTextColor(0, 0, 0);
                            y += 25;
                        } else {
                            doc.roundedRect(margin, y - 3, maxWidth, 10, 2, 2, 'FD');
                            doc.setTextColor(150, 150, 150);
                            doc.text(field.placeholder || '', margin + 5, y + 3);
                            doc.setTextColor(0, 0, 0);
                            y += 15;
                        }
                        break;
                }
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, 290, { align: 'center' });
            }

            doc.save(`${formTitle.replace(/\s+/g, '_')}.pdf`);
        }

        // Initialize with sample fields
        function loadSampleForm() {
            addField('heading');
            formFields[formFields.length - 1].label = 'Personal Information';
            
            addField('text');
            formFields[formFields.length - 1].label = 'Full Name';
            formFields[formFields.length - 1].required = true;
            
            addField('email');
            formFields[formFields.length - 1].required = true;
            
            addField('phone');
            
            addField('divider');
            
            addField('heading');
            formFields[formFields.length - 1].label = 'Additional Details';
            
            addField('date');
            formFields[formFields.length - 1].label = 'Date of Birth';
            
            addField('select');
            formFields[formFields.length - 1].label = 'Country';
            formFields[formFields.length - 1].options = ['United States', 'United Kingdom', 'Canada', 'Australia', 'Other'];
            
            addField('textarea');
            formFields[formFields.length - 1].label = 'Comments';
            formFields[formFields.length - 1].placeholder = 'Enter any additional comments...';
            
            closePropertiesPanel();
            renderFormFields();
        }

        // Create new form function - clears canvas for fresh start
        function createNewForm() {
            // Show confirmation if there are fields
            if (formFields.length > 0) {
                if (!confirm('Are you sure you want to create a new form? All current fields will be cleared.')) {
                    return;
                }
            }
            
            // Reset all form state
            formFields = [];
            selectedFieldId = null;
            fieldIdCounter = 0;
            currentLayout = 'flowable';
            currentViewMode = 'screen';
            
            // Reset form title
            document.getElementById('formTitle').value = 'New Form';
            document.getElementById('formTitleDisplay').textContent = 'New Form';
            
            // Reset layout radio buttons
            document.querySelector('input[name="layout"][value="flowable"]').checked = true;
            
            // Reset view mode radio buttons
            document.querySelector('input[name="viewMode"][value="screen"]').checked = true;
            updateViewMode('screen');
            
            // Reset drop zone layout
            const dropZone = document.getElementById('dropZone');
            dropZone.classList.add('flowable-grid');
            dropZone.classList.remove('space-y-4');
            
            // Close properties panel
            closePropertiesPanel();
            
            // Re-render empty canvas
            renderFormFields();
        }

        // Load sample form on start
        loadSampleForm();

        // ============================================
        // AI CHATBOT FUNCTIONALITY
        // ============================================
        
        let chatOpen = false;
        // Default GenSpark API key (can be overridden by user)
        const DEFAULT_GENSPARK_KEY = 'gsk-eyJjb2dlbl9pZCI6ICIyYjhjY2E4Ny03YzJjLTRhNDMtOWEzMC03ZjA2NzcxYWQwYWUiLCAia2V5X2lkIjogIjk2NDg4ZWRlLTEzOGYtNDE4Yy05NGVhLThkZjUxNmZkZTBhOSJ9fGu39u0z0M7qd-AbN5e7qZYXn2FRNkekLHwvDbwani-c';
        let apiKey = localStorage.getItem('genspark_api_key') || DEFAULT_GENSPARK_KEY;
        let chatHistory = [];

        // Load saved API key
        if (apiKey) {
            document.getElementById('apiKeyInput').value = apiKey;
        }

        function toggleChat() {
            chatOpen = !chatOpen;
            const chatWindow = document.getElementById('chatWindow');
            const iconOpen = document.getElementById('chatIconOpen');
            const iconClose = document.getElementById('chatIconClose');
            
            if (chatOpen) {
                chatWindow.classList.remove('hidden');
                chatWindow.style.animation = 'chatSlideIn 0.3s ease forwards';
                iconOpen.classList.add('hidden');
                iconClose.classList.remove('hidden');
            } else {
                chatWindow.style.animation = 'chatSlideOut 0.3s ease forwards';
                setTimeout(() => {
                    chatWindow.classList.add('hidden');
                }, 280);
                iconOpen.classList.remove('hidden');
                iconClose.classList.add('hidden');
            }
        }

        function toggleApiSettings() {
            const settings = document.getElementById('apiSettings');
            settings.classList.toggle('hidden');
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            apiKey = input.value.trim();
            
            if (apiKey) {
                localStorage.setItem('genspark_api_key', apiKey);
                showChatStatus('‚úì GenSpark API key saved!', 'success');
                toggleApiSettings();
                addBotMessage('üîë GenSpark API key saved! I\'m ready to help you build amazing forms with AI. What would you like to create?');
            } else {
                showChatStatus('Please enter a valid API key', 'error');
            }
        }

        function showChatStatus(message, type = 'info') {
            const status = document.getElementById('chatStatus');
            status.textContent = message;
            status.classList.remove('hidden', 'text-gray-400', 'text-green-500', 'text-red-500');
            
            if (type === 'success') {
                status.classList.add('text-green-500');
            } else if (type === 'error') {
                status.classList.add('text-red-500');
            } else {
                status.classList.add('text-gray-400');
            }
            
            setTimeout(() => {
                status.classList.add('hidden');
            }, 3000);
        }

        function addUserMessage(text) {
            const container = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex gap-3 justify-end';
            msgDiv.innerHTML = `
                <div class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-2xl rounded-tr-none px-4 py-3 shadow-sm max-w-[80%]">
                    <p class="text-sm">${escapeHtml(text)}</p>
                </div>
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addBotMessage(text) {
            const container = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex gap-3';
            msgDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="bg-white rounded-2xl rounded-tl-none px-4 py-3 shadow-sm max-w-[80%]">
                    <p class="text-sm text-gray-700">${text}</p>
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex gap-3';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="bg-white rounded-2xl rounded-tl-none px-4 py-3 shadow-sm">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!apiKey) {
                addBotMessage('‚ö†Ô∏è Please set up your GenSpark API key first. Click the ‚öôÔ∏è button in the header above.');
                return;
            }
            
            // Clear input and add user message
            input.value = '';
            addUserMessage(message);
            
            // Add to chat history
            chatHistory.push({ role: 'user', content: message });
            
            // Show typing indicator
            addTypingIndicator();
            
            try {
                // Get current form context
                const formContext = getFormContext();
                
                // Use GenSpark OpenAI Proxy (supports gpt-5-mini model!)
                const response = await fetch('https://www.genspark.ai/api/llm_proxy/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-mini', // Using faster, cheaper gpt-5-mini!
                        messages: [
                            {
                                role: 'system',
                                content: `You are a helpful AI assistant for a PDF Form Builder application. You help users create and customize forms. 

Current form state:
- Form Title: "${document.getElementById('formTitle').value}"
- Number of fields: ${formFields.length}
- Fields: ${formContext}

Available field types: text, email, phone, textarea, number, date, select (dropdown), checkbox, radio, file, heading, paragraph, divider.

You can help users:
1. Suggest form structures and field types
2. Provide tips on form design
3. Explain form building concepts
4. Answer questions about PDF forms

Be concise, friendly, and helpful. Use emojis occasionally to be engaging.`
                            },
                            ...chatHistory.slice(-10) // Keep last 10 messages for context
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                removeTypingIndicator();
                
                if (!response.ok) {
                    const error = await response.json();
                    if (response.status === 401) {
                        addBotMessage('‚ùå Invalid API key. Please check your GenSpark API key and try again.');
                    } else if (response.status === 429) {
                        addBotMessage('‚è≥ Rate limit exceeded. Please wait a moment and try again.');
                    } else {
                        addBotMessage(`‚ùå Error: ${error.error?.message || 'Something went wrong. Please try again.'}`);
                    }
                    return;
                }
                
                const data = await response.json();
                const botReply = data.choices[0]?.message?.content || 'I apologize, I couldn\'t generate a response.';
                
                // Add to history
                chatHistory.push({ role: 'assistant', content: botReply });
                
                // Display bot message
                addBotMessage(botReply);
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Chat error:', error);
                addBotMessage('‚ùå Connection error. Please check your internet connection and try again.');
            }
        }

        function getFormContext() {
            if (formFields.length === 0) {
                return 'No fields added yet.';
            }
            return formFields.map(f => `${f.type}: "${f.label}"`).join(', ');
        }
    </script>
</body>
</html>
