<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenSpark MindMap Agent - AI-Powered Mind Mapping</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- D3.js (Required for Markmap) -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
    <!-- Markmap Lib (Markdown parser) -->
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"></script>
    <!-- Markmap View (Renderer) -->
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4/dist/browser/index.min.js"></script>
    <!-- Markmap Toolbar -->
    <script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.15.4/dist/index.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .markmap-container { width: 100%; height: 100%; }
        /* Chat scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Message animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-bubble { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Loading dots animation */
        @keyframes pulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        .loading-dot {
            animation: pulse 1.4s infinite;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 p-3 px-6 flex justify-between items-center shadow-sm z-20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg">
                ğŸ§ 
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800">GenSpark MindMap Agent</h1>
                <p class="text-xs text-gray-500">AI-Powered Mind Mapping</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div class="text-xs text-green-600 bg-green-50 px-3 py-1.5 rounded-full border border-green-200 font-medium">
                âš¡ AI Active
            </div>
            <div class="text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full border border-gray-200">
                Powered by GenSpark
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-1/3 min-w-[320px] max-w-[450px] bg-white border-r border-gray-200 flex flex-col shadow-xl z-10">
            <!-- Chat History -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                <!-- Initial Message -->
                <div class="flex items-start gap-3 message-bubble">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold shrink-0">AI</div>
                    <div class="bg-white p-4 rounded-2xl rounded-tl-none border border-gray-100 shadow-sm text-sm text-gray-700 leading-relaxed">
                        <strong class="text-blue-600">Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î•Î¯Î¼Î±Î¹ Î¿ GenSpark MindMap Agent ğŸ§ </strong><br><br>
                        Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Ï Î´Î¹Î±Î³ÏÎ¬Î¼Î¼Î±Ï„Î± Î¼Îµ <strong>Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ® AI</strong>!<br><br>
                        <strong class="text-purple-600">Î¤Î¹ Î¼Ï€Î¿ÏÏ Î½Î± ÎºÎ¬Î½Ï‰:</strong>
                        <ul class="list-disc ml-4 mt-2 space-y-1 text-gray-600">
                            <li>"Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ mindmap Î³Î¹Î± [Î¸Î­Î¼Î±]"</li>
                            <li>"Î‘Î½Î¬Î»Ï…ÏƒÎµ Ï„Î¿ URL [link]"</li>
                            <li>"Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ [Î¹Î´Î­Î±] ÏƒÏ„Î¿ [ÎºÎ»Î±Î´Î¯]"</li>
                            <li>"Î•Ï€Î­ÎºÏ„ÎµÎ¹Î½Îµ Ï„Î¿ ÎºÎ»Î±Î´Î¯ [ÏŒÎ½Î¿Î¼Î±]"</li>
                            <li>Î‘Î½ÎµÎ²Î¬ÏƒÏ„Îµ Î±ÏÏ‡ÎµÎ¯Î¿ (.txt, .md, .json)</li>
                        </ul>
                        <div class="mt-3 text-xs text-gray-500 bg-blue-50 p-2 rounded border border-blue-100">
                            ğŸ’¡ <strong>Tip:</strong> ÎœÏ€Î¿ÏÏ Î½Î± ÎºÎ±Ï„Î±Î½Î¿Î®ÏƒÏ‰ Ï„Î¿ context ÎºÎ±Î¹ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÏ‰ Î­Î¾Ï…Ï€Î½Î± Î½Î­Î± nodes!
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="p-4 bg-white border-t border-gray-200 space-y-3">
                <!-- Toolbar -->
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                    <button onclick="exportAsJSON()" class="text-xs flex items-center gap-1 px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full transition whitespace-nowrap font-medium">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        JSON
                    </button>
                    <button onclick="exportAsCSV()" class="text-xs flex items-center gap-1 px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded-full transition whitespace-nowrap font-medium">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        CSV
                    </button>
                    <button onclick="downloadMap()" class="text-xs flex items-center gap-1 px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-full transition whitespace-nowrap font-medium">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        MD
                    </button>
                    <button onclick="resetMap()" class="text-xs flex items-center gap-1 px-3 py-1.5 bg-gray-100 hover:bg-red-50 hover:text-red-600 text-gray-700 rounded-full transition whitespace-nowrap">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        Clear
                    </button>
                </div>

                <!-- Inputs -->
                <div class="flex flex-col gap-2 relative">
                    <!-- File Upload Preview -->
                    <div id="file-preview" class="hidden text-xs bg-blue-50 text-blue-700 p-2 rounded border border-blue-200 flex justify-between items-center">
                        <span class="truncate max-w-[200px]" id="filename-display">file.txt</span>
                        <button onclick="clearFile()" class="hover:text-blue-900 font-bold">&times;</button>
                    </div>

                    <div class="flex items-end gap-2">
                        <!-- File Input -->
                        <label class="p-2.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg cursor-pointer transition" title="Upload file">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                            <input type="file" id="file-upload" class="hidden" accept=".txt,.md,.csv,.json">
                        </label>

                        <!-- Text Input -->
                        <textarea id="user-input" rows="1" placeholder="Ï€.Ï‡. 'Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ mindmap Î³Î¹Î± Digital Marketing'..." class="flex-1 px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white resize-none text-sm leading-normal max-h-32"></textarea>
                        
                        <!-- Send Button -->
                        <button id="send-btn" class="p-2.5 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Right Panel: MindMap -->
        <section class="flex-1 relative bg-slate-50">
            <!-- Toolbar container for Markmap -->
            <div id="toolbar-container" class="absolute bottom-6 right-6 z-10"></div>
            
            <svg id="markmap" class="w-full h-full opacity-0 transition-opacity duration-500"></svg>
            
            <!-- Empty State Placeholder -->
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none">
                <div class="text-6xl mb-4 opacity-20">ğŸ§ </div>
                <p class="text-lg font-medium opacity-50">ÎÎµÎºÎ¹Î½Î®ÏƒÏ„Îµ Ï„Î· ÏƒÏ…Î¶Î®Ï„Î·ÏƒÎ· Î¼Îµ Ï„Î¿ AI</p>
                <p class="text-sm opacity-30 mt-1">ÎŸ Ï‡Î¬ÏÏ„Î·Ï‚ Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÎ´Ï</p>
            </div>
        </section>
    </main>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ”‘ GenSpark API Key Required</h3>
            <p class="text-sm text-gray-600 mb-4">
                To use AI features, please enter your GenSpark API key:
            </p>
            <input type="text" id="api-key-input" placeholder="gsk-..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <div class="flex gap-2">
                <button onclick="saveApiKey()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">
                    Save & Continue
                </button>
                <button onclick="closeApiModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                    Cancel
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-3">
                Don't have a key? Get one at <a href="https://www.genspark.ai/settings" target="_blank" class="text-blue-600 hover:underline">genspark.ai/settings</a>
            </p>
        </div>
    </div>

    <script>
        // --- GenSpark AI Configuration ---
        const GENSPARK_CONFIG = {
            apiEndpoint: 'https://www.genspark.ai/api/llm_proxy/v1/chat/completions',
            model: 'gpt-5-mini',
            apiKey: localStorage.getItem('gensparkApiKey') || ''
        };

        // --- Markmap Configuration & State ---
        const { Transformer } = markmap;
        const { Markmap, loadCSS, loadJS } = markmap;
        
        let mm = null; // Markmap instance
        let currentMarkdown = "# ÎšÎµÎ½Ï„ÏÎ¹ÎºÏŒ Î˜Î­Î¼Î±\n## Î¥Ï€Î¿Î¸Î­Î¼Î± 1\n- Î™Î´Î­Î± Î‘\n- Î™Î´Î­Î± Î’\n## Î¥Ï€Î¿Î¸Î­Î¼Î± 2"; // Default content
        
        const transformer = new Transformer();

        // --- Elements ---
        const svgEl = document.querySelector('#markmap');
        const emptyState = document.getElementById('empty-state');
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const fileUpload = document.getElementById('file-upload');
        const filePreview = document.getElementById('file-preview');
        const filenameDisplay = document.getElementById('filename-display');
        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyInput = document.getElementById('api-key-input');

        let pendingFileContent = null;
        let conversationHistory = [];

        // --- API Key Management ---
        function checkApiKey() {
            if (!GENSPARK_CONFIG.apiKey) {
                apiKeyModal.classList.remove('hidden');
                return false;
            }
            return true;
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key && key.startsWith('gsk-')) {
                localStorage.setItem('gensparkApiKey', key);
                GENSPARK_CONFIG.apiKey = key;
                apiKeyModal.classList.add('hidden');
                addMessage('âœ… API Key Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ! ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¿ AI Ï„ÏÏÎ±.');
            } else {
                alert('âš ï¸ Invalid API key. It should start with "gsk-"');
            }
        }

        function closeApiModal() {
            apiKeyModal.classList.add('hidden');
        }

        // --- Initialization ---
        function initMarkmap() {
            if (mm) return;
            
            // Create markmap instance
            mm = Markmap.create(svgEl, {
                autoFit: true,
                duration: 500,
            });

            // Add toolbar
            const { Toolbar } = markmap;
            const toolbar = Toolbar.create(mm);
            document.getElementById('toolbar-container').appendChild(toolbar.el);

            renderMap();
            svgEl.classList.remove('opacity-0');
        }

        function renderMap() {
            if (!currentMarkdown.trim()) {
                emptyState.style.display = 'flex';
                const { root } = transformer.transform(currentMarkdown);
                mm.setData(root);
            } else {
                emptyState.style.display = 'none';
                const { root } = transformer.transform(currentMarkdown);
                mm.setData(root);
                mm.fit();
            }
        }

        // --- Chat Logic ---
        function addMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = `flex items-start gap-3 message-bubble ${isUser ? 'flex-row-reverse' : ''}`;
            
            const avatar = isUser 
                ? `<div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-white text-xs font-bold shrink-0">Î•Î“Î©</div>`
                : `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold shrink-0">AI</div>`;
            
            const bubbleColor = isUser ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white' : 'bg-white border border-gray-100 text-gray-700 shadow-sm';
            const bubbleRound = isUser ? 'rounded-tr-none' : 'rounded-tl-none';

            const avatarContainer = document.createElement('div');
            avatarContainer.innerHTML = avatar;
            
            const textContainer = document.createElement('div');
            textContainer.className = `${bubbleColor} p-3 rounded-2xl ${bubbleRound} text-sm leading-relaxed max-w-[85%]`;
            
            if (isUser) {
                textContainer.textContent = text;
            } else {
                textContainer.innerHTML = text; 
            }

            div.appendChild(avatarContainer.firstChild);
            div.appendChild(textContainer);
            
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function addLoadingMessage() {
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex items-center gap-2 text-xs text-gray-400 ml-12 mb-2';
            loadingDiv.innerHTML = `
                <div class="flex gap-1">
                    <span class="w-2 h-2 bg-blue-400 rounded-full loading-dot"></span>
                    <span class="w-2 h-2 bg-purple-400 rounded-full loading-dot"></span>
                    <span class="w-2 h-2 bg-blue-400 rounded-full loading-dot"></span>
                </div>
                <span class="animate-pulse">Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹...</span>
            `;
            chatHistory.appendChild(loadingDiv);
            return loadingId;
        }

        function removeLoadingMessage(loadingId) {
            const el = document.getElementById(loadingId);
            if (el) el.remove();
        }

        async function handleSend() {
            const text = userInput.value.trim();
            
            if (!text && !pendingFileContent) return;

            // Check API key
            if (!checkApiKey()) return;

            // User Message
            if (text) addMessage(text, true);
            if (pendingFileContent) {
                addMessage(`ğŸ“ Î‘Î½Î­Î²Î·ÎºÎµ Î±ÏÏ‡ÎµÎ¯Î¿: ${filenameDisplay.innerText}`, true);
            }

            userInput.value = '';
            
            // Show loading
            const loadingId = addLoadingMessage();

            // Process with AI
            try {
                await processAgentCommandAI(text, pendingFileContent);
            } catch (error) {
                console.error('AI Error:', error);
                addMessage(`âŒ Î£Ï†Î¬Î»Î¼Î±: ${error.message}. Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î¿ API key.`);
            }

            removeLoadingMessage(loadingId);
            
            // Clear pending file
            if (pendingFileContent) clearFile();
        }

        // --- AI Agent Logic ---
        async function processAgentCommandAI(command, fileContent) {
            let userMessage = command;
            
            // Handle file content
            if (fileContent) {
                userMessage = `Î§ÏÎ®ÏƒÏ„Î·Ï‚ Î±Î½Î­Î²Î±ÏƒÎµ Î±ÏÏ‡ÎµÎ¯Î¿ (${filenameDisplay.innerText}):\n\n${fileContent.substring(0, 3000)}`;
            }

            // Build conversation context
            const systemPrompt = `Î•Î¯ÏƒÎ±Î¹ Î­Î½Î±Ï‚ AI MindMap Agent. Î— Î´Î¿Ï…Î»ÎµÎ¹Î¬ ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯Ï‚ ÎºÎ±Î¹ Î½Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î¬Î¶ÎµÏƒÎ±Î¹ mind maps ÏƒÎµ Markdown format.

Î¤Î¡Î•Î§Î©Î Î§Î‘Î¡Î¤Î—Î£:
\`\`\`markdown
${currentMarkdown}
\`\`\`

ÎŸÎ”Î—Î“Î™Î•Î£:
1. Î‘Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¶Î·Ï„Î¬ Î½Î± "Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹Ï‚" Î½Î­Î¿ Ï‡Î¬ÏÏ„Î·, Î´Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Î­Î½Î± ÎŸÎ›ÎŸÎšÎ›Î—Î¡Î©ÎœÎ•ÎÎŸ Markdown mindmap Î³Î¹Î± Ï„Î¿ Î¸Î­Î¼Î± Ï„Î¿Ï…
2. Î‘Î½ Î¶Î·Ï„Î¬ Î½Î± "Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚" ÎºÎ¬Ï„Î¹, Î²ÏÎµÏ‚ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ ÏƒÎ·Î¼ÎµÎ¯Î¿ ÏƒÏ„Î¿Î½ Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î± Ï‡Î¬ÏÏ„Î· ÎºÎ±Î¹ Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï„Î¿
3. Î‘Î½ Î¶Î·Ï„Î¬ Î½Î± "ÎµÏ€ÎµÎºÏ„ÎµÎ¯Î½ÎµÎ¹Ï‚" Î­Î½Î± ÎºÎ»Î±Î´Î¯, Î²ÏÎµÏ‚ Ï„Î¿ ÎºÎ»Î±Î´Î¯ ÎºÎ±Î¹ Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± Ï…Ï€Î¿Î¸Î­Î¼Î±Ï„Î±
4. Î‘Î½ Î±Î½ÎµÎ²Î¬ÏƒÎµÎ¹ Î±ÏÏ‡ÎµÎ¯Î¿, Î¼ÎµÏ„Î­Ï„ÏÎµÏˆÎ­ Ï„Î¿ ÏƒÎµ Î´Î¿Î¼Î·Î¼Î­Î½Î¿ mindmap
5. Î‘Î½ Î¶Î·Ï„Î¬ Î±Î½Î¬Î»Ï…ÏƒÎ· URL, Ï€ÎµÏ‚ Ï„Î¿Ï… ÏŒÏ„Î¹ Ï„Î¿ feature Î­ÏÏ‡ÎµÏ„Î±Î¹ ÏƒÏÎ½Ï„Î¿Î¼Î±

Î‘Î Î‘ÎÎ¤Î—Î£Î— Î£ÎŸÎ¥ Î Î¡Î•Î Î•Î™ ÎÎ‘ Î•Î§Î•Î™ Î”Î¥ÎŸ ÎœÎ•Î¡Î—:
1. MARKDOWN: ÎŸ Î½Î­Î¿Ï‚/ÎµÎ½Î·Î¼ÎµÏÏ‰Î¼Î­Î½Î¿Ï‚ Ï‡Î¬ÏÏ„Î·Ï‚ ÏƒÎµ Markdown format (Î¼Î­ÏƒÎ± ÏƒÎµ \`\`\`markdown ... \`\`\`)
2. MESSAGE: ÎˆÎ½Î± Ï†Î¹Î»Î¹ÎºÏŒ Î¼Î®Î½Ï…Î¼Î± Ï€ÏÎ¿Ï‚ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· (2-3 Î³ÏÎ±Î¼Î¼Î­Ï‚)

Î Î‘Î¡Î‘Î”Î•Î™Î“ÎœÎ‘:
\`\`\`markdown
# Digital Marketing
## Social Media
- Facebook Ads
- Instagram Stories
- LinkedIn B2B
## SEO
- On-Page
- Technical
- Link Building
\`\`\`

MESSAGE: Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎ± Î­Î½Î± Î±Î½Î±Î»Ï…Ï„Î¹ÎºÏŒ mindmap Î³Î¹Î± Digital Marketing Î¼Îµ 2 ÎºÏÏÎ¹ÎµÏ‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚. Î˜Î­Î»ÎµÏ„Îµ Î½Î± ÎµÏ€ÎµÎºÏ„ÎµÎ¯Î½Ï‰ ÎºÎ¬Ï€Î¿Î¹Î¿ ÎºÎ»Î±Î´Î¯;`;

            conversationHistory.push({
                role: 'user',
                content: userMessage
            });

            // Call GenSpark AI
            const response = await fetch(GENSPARK_CONFIG.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${GENSPARK_CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: GENSPARK_CONFIG.model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        ...conversationHistory
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;

            // Parse AI response
            const markdownMatch = aiResponse.match(/```markdown\n([\s\S]+?)\n```/);
            const messageMatch = aiResponse.match(/MESSAGE:\s*(.+?)(?:\n\n|$)/s);

            if (markdownMatch) {
                currentMarkdown = markdownMatch[1].trim();
                renderMap();
            }

            const responseMessage = messageMatch ? messageMatch[1].trim() : aiResponse;
            addMessage(responseMessage);

            conversationHistory.push({
                role: 'assistant',
                content: aiResponse
            });

            // Keep conversation history reasonable
            if (conversationHistory.length > 10) {
                conversationHistory = conversationHistory.slice(-10);
            }
        }

        // --- Export Functions ---
        function exportAsJSON() {
            const data = {
                title: currentMarkdown.split('\n')[0].replace('#', '').trim(),
                markdown: currentMarkdown,
                exported: new Date().toISOString(),
                tool: 'GenSpark MindMap Agent'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadBlob(blob, 'mindmap.json');
            addMessage('âœ… Exported as JSON');
        }

        function exportAsCSV() {
            const lines = currentMarkdown.split('\n').filter(l => l.trim());
            let csv = 'Level,Content\n';
            
            lines.forEach(line => {
                const level = (line.match(/^#+/) || [''])[0].length || (line.match(/^-/) ? 99 : 0);
                const content = line.replace(/^#+\s*|-\s*/, '').trim();
                csv += `${level},"${content.replace(/"/g, '""')}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            downloadBlob(blob, 'mindmap.csv');
            addMessage('âœ… Exported as CSV');
        }

        function downloadMap() {
            const blob = new Blob([currentMarkdown], { type: 'text/markdown' });
            downloadBlob(blob, 'mindmap.md');
            addMessage('âœ… Downloaded as Markdown');
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- Helpers ---
        function clearFile() {
            fileUpload.value = '';
            pendingFileContent = null;
            filePreview.classList.add('hidden');
        }

        function resetMap() {
            if (confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿Î½ Ï‡Î¬ÏÏ„Î·;')) {
                currentMarkdown = "# New MindMap";
                conversationHistory = [];
                renderMap();
                addMessage("ğŸ—‘ï¸ ÎŸ Ï‡Î¬ÏÏ„Î·Ï‚ ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ.");
            }
        }

        // --- Event Listeners ---
        window.addEventListener('load', () => {
            initMarkmap();
            // Auto-check API key on load
            setTimeout(() => {
                if (!GENSPARK_CONFIG.apiKey) {
                    addMessage('âš ï¸ Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ Î­Î½Î± GenSpark API key Î³Î¹Î± Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¹Ï‚ AI Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚. ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº ÏƒÏ„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ Î³Î¹Î± Î½Î± ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ„Îµ.');
                }
            }, 1000);
        });
        
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        // Resize input text area automatically
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            filenameDisplay.innerText = file.name;
            filePreview.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                pendingFileContent = e.target.result;
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>
